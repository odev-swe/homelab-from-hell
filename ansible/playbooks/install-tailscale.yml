---
# ==============================================================================
# Ansible Playbook: Install and Configure Tailscale
# ==============================================================================
#
# Description:
#   This playbook installs Tailscale VPN on target hosts and optionally
#   authenticates them to your Tailnet.
#
# Requirements:
#   - Ubuntu/Debian based systems (18.04+)
#   - Internet connectivity
#   - Sudo privileges
#
# Usage:
#   # Install Tailscale on all kubernetes hosts
#   ansible-playbook playbooks/install-tailscale.yml
#
#   # Install with authentication (requires auth key)
#   ansible-playbook playbooks/install-tailscale.yml \
#     -e "tailscale_auth_key=tskey-auth-xxxxx"
#
#   # Install on specific host
#   ansible-playbook playbooks/install-tailscale.yml \
#     --limit k8s-master
#
#   # Install with custom options
#   ansible-playbook playbooks/install-tailscale.yml \
#     -e "tailscale_advertise_routes=192.168.100.0/24" \
#     -e "tailscale_accept_routes=true"
#
# Variables:
#   tailscale_auth_key: Tailscale authentication key (optional)
#   tailscale_hostname: Custom hostname for the node (optional)
#   tailscale_advertise_routes: Routes to advertise (optional)
#   tailscale_accept_routes: Accept routes from other nodes (default: false)
#   tailscale_advertise_exit_node: Advertise as exit node (default: false)
#   tailscale_accept_dns: Accept DNS configuration (default: true)
#
# ==============================================================================

- name: Install and Configure Tailscale VPN
  hosts: kubernetes
  become: true
  gather_facts: true

  vars:
    # Tailscale version (leave empty for latest)
    tailscale_version: ""
    
    # Authentication (set via -e or in group_vars)
    tailscale_auth_key: ""
    
    # Tailscale configuration
    tailscale_hostname: ""
    tailscale_advertise_routes: ""
    tailscale_accept_routes: false
    tailscale_advertise_exit_node: false
    tailscale_accept_dns: true
    tailscale_ssh: true
    
    # Installation options
    tailscale_force_reinstall: false

  tasks:
    # ==========================================================================
    # Pre-flight Checks
    # ==========================================================================

    - name: Display installation information
      ansible.builtin.debug:
        msg:
          - "Installing Tailscale on {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Architecture: {{ ansible_architecture }}"
          - "Auth Key Provided: {{ 'Yes' if tailscale_auth_key else 'No' }}"
      tags: [always]

    - name: Check if Tailscale is already installed
      ansible.builtin.command: which tailscale
      register: tailscale_installed
      changed_when: false
      failed_when: false
      tags: [check]

    - name: Display current installation status
      ansible.builtin.debug:
        msg: "Tailscale is {{ 'already installed' if tailscale_installed.rc == 0 else 'not installed' }}"
      tags: [check]

    # ==========================================================================
    # System Preparation
    # ==========================================================================

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      tags: [install]

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - curl
          - gpg
          - apt-transport-https
          - ca-certificates
        state: present
      when: ansible_os_family == "Debian"
      tags: [install]

    # ==========================================================================
    # Tailscale Installation
    # ==========================================================================

    - name: Add Tailscale GPG key
      ansible.builtin.apt_key:
        url: https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_distribution_release }}.noarmor.gpg
        state: present
        keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
      when: 
        - ansible_os_family == "Debian"
        - tailscale_installed.rc != 0 or tailscale_force_reinstall
      tags: [install]

    - name: Add Tailscale repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ ansible_distribution_release }} main"
        state: present
        filename: tailscale
      when:
        - ansible_os_family == "Debian"
        - tailscale_installed.rc != 0 or tailscale_force_reinstall
      tags: [install]

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale{{ '=' + tailscale_version if tailscale_version else '' }}
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
      notify: Restart Tailscale
      tags: [install]

    # ==========================================================================
    # Tailscale Configuration
    # ==========================================================================

    - name: Enable and start tailscaled service
      ansible.builtin.systemd:
        name: tailscaled
        enabled: yes
        state: started
      tags: [configure]

    - name: Check Tailscale connection status
      ansible.builtin.command: tailscale status
      register: tailscale_status
      changed_when: false
      failed_when: false
      tags: [configure, status]

    - name: Build Tailscale up command
      ansible.builtin.set_fact:
        tailscale_up_cmd: >-
          tailscale up
          {{ '--authkey=' + tailscale_auth_key if tailscale_auth_key else '' }}
          {{ '--hostname=' + tailscale_hostname if tailscale_hostname else '' }}
          {{ '--advertise-routes=' + tailscale_advertise_routes if tailscale_advertise_routes else '' }}
          {{ '--accept-routes' if tailscale_accept_routes else '' }}
          {{ '--advertise-exit-node' if tailscale_advertise_exit_node else '' }}
          {{ '--accept-dns=' + (tailscale_accept_dns | string | lower) }}
          {{ '--ssh' if tailscale_ssh else '' }}
      tags: [configure]

    - name: Authenticate and configure Tailscale
      ansible.builtin.command: "{{ tailscale_up_cmd }}"
      register: tailscale_up_result
      changed_when: "'Success' in tailscale_up_result.stdout or 'Success' in tailscale_up_result.stderr"
      failed_when: false
      when: tailscale_auth_key or "'Logged out' in tailscale_status.stdout"
      tags: [configure]

    - name: Display authentication result
      ansible.builtin.debug:
        var: tailscale_up_result
      when: tailscale_up_result is defined and tailscale_up_result.changed
      tags: [configure]

    # ==========================================================================
    # Post-Installation Checks
    # ==========================================================================

    - name: Get Tailscale status
      ansible.builtin.command: tailscale status --json
      register: tailscale_status_json
      changed_when: false
      tags: [status]

    - name: Parse Tailscale status
      ansible.builtin.set_fact:
        tailscale_info: "{{ tailscale_status_json.stdout | from_json }}"
      tags: [status]

    - name: Display Tailscale information
      ansible.builtin.debug:
        msg:
          - "Tailscale Status: {{ 'Connected' if tailscale_info.BackendState == 'Running' else tailscale_info.BackendState }}"
          - "Tailscale IP: {{ tailscale_info.Self.TailscaleIPs | default(['Not assigned']) | join(', ') }}"
          - "Node Name: {{ tailscale_info.Self.HostName | default('N/A') }}"
          - "Online: {{ tailscale_info.Self.Online | default(false) }}"
      when: tailscale_info is defined
      tags: [status]

    - name: Get Tailscale version
      ansible.builtin.command: tailscale version
      register: tailscale_version_output
      changed_when: false
      tags: [status]

    - name: Display Tailscale version
      ansible.builtin.debug:
        msg: "{{ tailscale_version_output.stdout_lines[0] }}"
      tags: [status]

    # ==========================================================================
    # Firewall Configuration (if UFW is enabled)
    # ==========================================================================

    - name: Check if UFW is active
      ansible.builtin.command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false
      tags: [firewall]

    - name: Allow Tailscale through UFW
      community.general.ufw:
        rule: allow
        port: "41641"
        proto: udp
        comment: "Tailscale"
      when: 
        - ufw_status.rc == 0
        - "'Status: active' in ufw_status.stdout"
      tags: [firewall]

  # ============================================================================
  # Handlers
  # ============================================================================

  handlers:
    - name: Restart Tailscale
      ansible.builtin.systemd:
        name: tailscaled
        state: restarted

  # ============================================================================
  # Post-Play Recap
  # ============================================================================

  post_tasks:
    - name: Installation Summary
      ansible.builtin.debug:
        msg:
          - "╔════════════════════════════════════════════════════════════╗"
          - "║          Tailscale Installation Complete                  ║"
          - "╚════════════════════════════════════════════════════════════╝"
          - ""
          - "Next Steps:"
          - "  1. If not authenticated, visit: https://login.tailscale.com/"
          - "  2. Approve the machine in your Tailscale admin console"
          - "  3. Test connectivity: tailscale ping <node-name>"
          - "  4. Check status: tailscale status"
          - ""
          - "Useful Commands:"
          - "  • tailscale status           - Show connection status"
          - "  • tailscale ip               - Show Tailscale IPs"
          - "  • tailscale ping <host>      - Test connectivity"
          - "  • tailscale netcheck         - Network diagnostics"
          - "  • tailscale logout           - Disconnect from Tailnet"
          - ""
      run_once: true
      tags: [always]
