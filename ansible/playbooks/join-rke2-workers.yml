---
# ==============================================================================
# Ansible Playbook: Join RKE2 Worker Nodes to Cluster
# ==============================================================================
#
# Description:
#   This playbook installs RKE2 agent on worker nodes and joins them to an
#   existing RKE2 cluster.
#
# Prerequisites:
#   - RKE2 server (master) already installed and running
#   - Worker node VMs created and accessible via SSH
#   - Network connectivity between master and workers
#
# Usage:
#   # Join all worker nodes
#   ansible-playbook playbooks/join-rke2-workers.yml
#
#   # Join specific worker
#   ansible-playbook playbooks/join-rke2-workers.yml --limit k8s-worker-1
#
# ==============================================================================

- name: Get RKE2 Server Token and Configuration
  hosts: k8s_master
  become: true
  gather_facts: false

  tasks:
  - name: Get RKE2 server node token
    ansible.builtin.slurp:
      src: /var/lib/rancher/rke2/server/node-token
    register: rke2_token

  - name: Set token as fact
    ansible.builtin.set_fact:
      rke2_node_token: "{{ rke2_token.content | b64decode | trim }}"

  - name: Get master node IP
    ansible.builtin.set_fact:
      rke2_server_url: "https://{{ ansible_host }}:9345"

- name: Install and Configure RKE2 Agent on Worker Nodes
  hosts: k8s_workers
  become: true
  gather_facts: true

  vars:
    rke2_node_token: "{{ hostvars[groups['k8s_master'][0]]['rke2_node_token'] }}"
    rke2_server_url: "{{ hostvars[groups['k8s_master'][0]]['rke2_server_url'] }}"

  tasks:
  - name: Display connection information
    ansible.builtin.debug:
      msg:
      - "Joining worker: {{ inventory_hostname }}"
      - "Master server: {{ rke2_server_url }}"
      - "Token available: {{ 'Yes' if rke2_node_token else 'No' }}"

  - name: Install qemu-guest-agent
    ansible.builtin.apt:
      name: qemu-guest-agent
      state: present
      update_cache: true

  - name: Enable and start qemu-guest-agent service
    ansible.builtin.systemd:
      name: qemu-guest-agent
      enabled: true
      state: started

  - name: Check if RKE2 agent is already installed
    ansible.builtin.stat:
      path: /usr/local/bin/rke2
    register: rke2_installed

  - name: Check if RKE2 agent is already running
    ansible.builtin.systemd:
      name: rke2-agent
    register: rke2_service_status
    ignore_errors: true

  - name: Display RKE2 installation status
    ansible.builtin.debug:
      msg: 
        - "RKE2 installed: {{ rke2_installed.stat.exists }}"
        - "RKE2 agent running: {{ rke2_service_status.status.ActiveState | default('not installed') == 'active' }}"

  - name: Skip installation if RKE2 is already installed and running
    ansible.builtin.debug:
      msg: "RKE2 agent is already installed and running. Skipping installation steps."
    when: 
      - rke2_installed.stat.exists
      - rke2_service_status.status.ActiveState is defined
      - rke2_service_status.status.ActiveState == 'active'

  - name: Download RKE2 installer script
    ansible.builtin.get_url:
      url: https://get.rke2.io
      dest: /tmp/install-rke2.sh
      mode: '0755'
    when: not rke2_installed.stat.exists

  - name: Install RKE2 agent using official installer
    ansible.builtin.shell: |
      INSTALL_RKE2_TYPE="agent" sh /tmp/install-rke2.sh
    args:
      executable: /bin/bash
    when: not rke2_installed.stat.exists
    changed_when: true

  - name: Create RKE2 config directory
    ansible.builtin.file:
      path: /etc/rancher/rke2
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Configure RKE2 agent
    ansible.builtin.copy:
      content: |
        server: {{ rke2_server_url }}
        token: {{ rke2_node_token }}
        node-name: {{ inventory_hostname }}
      dest: /etc/rancher/rke2/config.yaml
      owner: root
      group: root
      mode: '0600'
    when: not (rke2_installed.stat.exists and rke2_service_status.status.ActiveState | default('') == 'active')

  - name: Enable RKE2 agent service
    ansible.builtin.systemd:
      name: rke2-agent
      enabled: true
      daemon_reload: true
    when: not (rke2_installed.stat.exists and rke2_service_status.status.ActiveState | default('') == 'active')

  - name: Start RKE2 agent service
    ansible.builtin.systemd:
      name: rke2-agent
      state: started
    register: rke2_start
    when: not (rke2_installed.stat.exists and rke2_service_status.status.ActiveState | default('') == 'active')

  - name: Wait for RKE2 agent to initialize
    ansible.builtin.pause:
      seconds: 20
      prompt: "Waiting for RKE2 agent to initialize..."
    when: not (rke2_installed.stat.exists and rke2_service_status.status.ActiveState | default('') == 'active')

  - name: Check RKE2 agent service status (final check)
    ansible.builtin.systemd:
      name: rke2-agent
    register: rke2_status_final

  - name: Display agent status
    ansible.builtin.debug:
      msg:
        - "RKE2 Agent Status: {{ rke2_status_final.status.ActiveState }}"
        - "Service Running: {{ rke2_status_final.status.SubState }}"

  - name: Fail if RKE2 agent is not running
    ansible.builtin.fail:
      msg: "RKE2 agent failed to start. Check logs with: journalctl -u rke2-agent -n 50"
    when: rke2_status_final.status.ActiveState != "active"

  - name: Create kube directory for worker user
    ansible.builtin.file:
      path: "/home/{{ ansible_user }}/.kube"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '0700'

- name: Verify Worker Nodes Have Joined
  hosts: k8s_master
  become: true
  gather_facts: false

  tasks:
  - name: Wait for nodes to appear in cluster
    ansible.builtin.pause:
      seconds: 15
      prompt: "Waiting for nodes to register..."

  - name: Get all cluster nodes
    ansible.builtin.command: kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes -o wide
    register: cluster_nodes
    changed_when: false

  - name: Display cluster nodes
    ansible.builtin.debug:
      var: cluster_nodes.stdout_lines

  - name: Get node count
    ansible.builtin.shell: |
      kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes --no-headers | wc -l
    register: node_count
    changed_when: false

  - name: Verify worker nodes are Ready
    ansible.builtin.shell: |
      kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -o "True" | wc -l
    register: ready_nodes
    changed_when: false

  - name: Display cluster status
    ansible.builtin.debug:
      msg:
      - "Total nodes in cluster: {{ node_count.stdout }}"
      - "Nodes in Ready state: {{ ready_nodes.stdout }}"
      - "Expected: {{ groups['k8s_master'] | length + groups['k8s_workers'] | length }}"

  - name: Check for worker labels
    ansible.builtin.shell: |
      kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes -l node-role.kubernetes.io/worker=true -o name
    register: worker_nodes
    changed_when: false

  - name: Display worker nodes
    ansible.builtin.debug:
      msg: "Worker nodes: {{ worker_nodes.stdout_lines }}"

  post_tasks:
  - name: Installation Summary
    ansible.builtin.debug:
      msg:
      - "╔════════════════════════════════════════════════════════════╗"
      - "║       RKE2 Worker Nodes Successfully Joined                ║"
      - "╚════════════════════════════════════════════════════════════╝"
      - ""
      - "Cluster Status:"
      - "  • Total nodes: {{ node_count.stdout }}"
      - "  • Ready nodes: {{ ready_nodes.stdout }}"
      - ""
      - "Next Steps:"
      - "  1. Verify nodes: kubectl get nodes"
      - "  2. Check pods: kubectl get pods -A"
      - "  3. Test workload: kubectl run test-nginx --image=nginx"
      - "  4. View logs: kubectl logs <pod-name>"
      - ""
      - "Worker Node Management:"
      - "  • Add labels: kubectl label node <name> key=value"
      - "  • Cordon node: kubectl cordon <node-name>"
      - "  • Drain node: kubectl drain <node-name>"
      - "  • Remove node: kubectl delete node <node-name>"
      - ""
    run_once: true
